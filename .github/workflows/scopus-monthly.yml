name: Update Scopus Publications

on:
  schedule:
    # Runs at 05:00 UTC on the 1st of every month
    - cron: '0 5 1 * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI
  push:
    paths:
      - '.github/workflows/scopus-monthly.yml'
      - 'scopus_fetcher.py'
      - 'data/authors.csv'

permissions:
  contents: write

jobs:
  update-scopus:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: ğŸ“¦ Install dependencies
        run: pip install requests
        
      - name: ğŸ“Š Create data directories
        run: mkdir -p data/scopus
        
      - name: ğŸ”‘ Fetch Scopus Data
        env:
          SCOPUS_API_KEY: ${{ secrets.SCOPUS_API_KEY }}
          SCOPUS_AUTHOR_ID: ${{ secrets.SCOPUS_AUTHOR_ID }}
        run: |
          echo "Starting Scopus data fetch..."
          python scopus_fetcher.py
          
      - name: âœ… Verify generated files
        run: |
          echo "Generated files:"
          ls -la data/scopus/
          echo ""
          echo "Sample of scopus.json (first 3 entries):"
          head -n 50 data/scopus/scopus.json || echo "No scopus.json found"
          echo ""
          echo "Metrics:"
          cat data/scopus/metrics.json || echo "No metrics.json found"
          
      - name: ğŸ’¾ Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check if there are changes
          git add data/scopus/
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“š docs: auto-update Scopus publications [skip ci]"
            git push
            echo "âœ… Changes pushed successfully!"
          fi
